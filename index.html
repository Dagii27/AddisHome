<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Addis Home ET - Broker Portal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary: #2a91e9;
      --primary-dark: #1a7bc8;
      --accent: #FF6B00;
      --text: #333333;
      --light-gray: #f5f7fa;
      --border: #e1e5eb;
      --error: #e74c3c;
      --success: #2ecc71;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    body {
      background-color: var(--light-gray);
      color: var(--text);
      line-height: 1.6;
    }
    .container {
      padding: 16px;
      max-width: 100%;
    }
    .form-header {
      background-color: white;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .back-btn {
      margin-right: 12px;
      color: var(--primary);
      font-weight: bold;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      line-height: 1;
    }
    .form-title {
      font-size: 18px;
      font-weight: 600;
    }
    .form-card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .required:after {
      content: " *";
      color: var(--error);
    }
    .form-control {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    .error-message {
      color: var(--error);
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-accent {
      background-color: var(--accent);
      color: white;
    }
    .btn-accent:hover {
      background-color: #e05a00;
    }
    .btn-accent:disabled {
      background-color: #f9b488;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    .radio-group {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }
    .radio-option {
      display: flex;
      align-items: center;
    }
    .radio-option input {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Registration Form View -->
    <div id="registration-view" class="hidden">
      <div class="form-header">
        <h1 class="form-title">üìù Broker Registration</h1>
      </div>
      <div class="form-card">
        <div class="form-group">
          <label for="full-name" class="form-label required">Full Name</label>
          <input type="text" id="full-name" class="form-control" placeholder="Enter your legal name" required>
          <div class="error-message" id="name-error">Please enter your full name</div>
        </div>
        <div class="form-group">
          <label for="phone" class="form-label required">Phone Number</label>
          <input type="tel" id="phone" class="form-control" placeholder="0912345678" required>
          <div class="error-message" id="phone-error">Please enter a valid phone number</div>
        </div>
        <button id="register-btn" class="btn btn-accent">Complete Registration</button>
      </div>
    </div>

    <!-- Listing Form View -->
    <div id="listing-view" class="hidden">
      <div class="form-header">
        <h1 class="form-title">üè† New Property Listing</h1>
      </div>
      <div class="form-card">
        <div class="form-group">
          <label for="title" class="form-label required">Property Title</label>
          <input type="text" id="title" class="form-control" placeholder="e.g., 3BR Luxury Apartment in Bole" required>
          <div class="error-message" id="title-error">Title is required</div>
        </div>
        <div class="form-group">
            <label for="price" class="form-label required">Price (ETB)</label>
            <input type="number" id="price" class="form-control" min="0" required>
            <div class="error-message" id="price-error">A valid price is required</div>
        </div>
        <div class="form-group">
            <label class="form-label required">Listing Type</label>
            <div class="radio-group">
              <label class="radio-option"><input type="radio" name="listing-type" value="rent" checked> For Rent</label>
              <label class="radio-option"><input type="radio" name="listing-type" value="sale"> For Sale</label>
            </div>
        </div>
        <div class="form-group">
          <label for="description" class="form-label">Description (Optional)</label>
          <textarea id="description" class="form-control" rows="4" placeholder="Add more details about the property..."></textarea>
        </div>
        <button id="submit-listing-btn" class="btn btn-accent">Publish Listing</button>
      </div>
    </div>

    <!-- Fallback View (if no action is specified) -->
    <div id="default-view" class="hidden">
         <div class="form-card" style="text-align: center;">
            <h2>Addis Home ET</h2>
            <p>Please use the buttons inside the Telegram bot to register or post a new property.</p>
         </div>
    </div>

  </div>

  <script>
    const tg = window.Telegram.WebApp;

    // --- DOM Elements ---
    const registrationView = document.getElementById('registration-view');
    const listingView = document.getElementById('listing-view');
    const defaultView = document.getElementById('default-view');

    const registerBtn = document.getElementById('register-btn');
    const submitListingBtn = document.getElementById('submit-listing-btn');

    // --- Form Validation ---
    function validateAndCollect(formId, fields) {
        let isValid = true;
        const data = {};

        fields.forEach(field => {
            const el = document.getElementById(field.id);
            const errorEl = document.getElementById(field.errorId);
            const value = el.value.trim();

            if (!value) {
                errorEl.style.display = 'block';
                isValid = false;
            } else {
                errorEl.style.display = 'none';
                data[field.key] = value;
            }
        });
        return isValid ? data : null;
    }


    // --- Event Listeners ---
    registerBtn.addEventListener('click', () => {
        const formData = validateAndCollect('registration-view', [
            { id: 'full-name', key: 'name', errorId: 'name-error' },
            { id: 'phone', key: 'phone', errorId: 'phone-error' }
        ]);

        if (formData) {
            // Add the action key for the bot
            formData.action = 'register';

            // Send data to the bot
            tg.sendData(JSON.stringify(formData));
            registerBtn.disabled = true;
            // The bot will reply, and the user can close the web app.
            // Or we can close it for them after a short delay.
            setTimeout(() => tg.close(), 500);
        }
    });

    submitListingBtn.addEventListener('click', () => {
        const titleEl = document.getElementById('title');
        const priceEl = document.getElementById('price');
        const descEl = document.getElementById('description');
        const typeEl = document.querySelector('input[name="listing-type"]:checked');
        
        const titleError = document.getElementById('title-error');
        const priceError = document.getElementById('price-error');
        
        let isValid = true;

        if (!titleEl.value.trim()) {
            titleError.style.display = 'block';
            isValid = false;
        } else {
            titleError.style.display = 'none';
        }

        if (!priceEl.value || isNaN(priceEl.value) || Number(priceEl.value) <= 0) {
            priceError.style.display = 'block';
            isValid = false;
        } else {
            priceError.style.display = 'none';
        }

        if (isValid) {
            const listingData = {
                action: 'post_listing', // This key is crucial for the bot
                title: titleEl.value.trim(),
                price: priceEl.value,
                type: typeEl.value,
                description: descEl.value.trim()
            };

            // Send data to the bot and close the web app
            tg.sendData(JSON.stringify(listingData));
            submitListingBtn.disabled = true;
            tg.close();
        }
    });

    // --- Initialization Logic ---
    function initialize() {
        // Expand the web app to full height
        tg.expand();

        // Get URL parameters to decide which view to show
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');

        // Show the correct view based on the 'action' parameter from the bot
        if (action === 'register') {
            registrationView.classList.remove('hidden');
        } else if (action === 'post') {
            listingView.classList.remove('hidden');
        } else {
            // Fallback if the app is opened without a specific action
            defaultView.classList.remove('hidden');
        }
    }

    // Run initialization when the DOM is fully loaded
    document.addEventListener("DOMContentLoaded", initialize);

  </script>
</body>
</html>
